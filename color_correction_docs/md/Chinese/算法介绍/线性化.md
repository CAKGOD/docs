## 线性化

进行色彩校正的时候，对测量数据的第一步操作便是将其线性化。由于测量色彩空间尚未标定，我们通常采用一些经验的方式来进行线性化。经验上通常采用的线性化有这么几种。一是使用伽马校正，二是使用多项式拟合。

线性化一般是逐元素（elementwise）的函数。数学符号统一如下：

$C$: 数据的任一元素，可以是$R,G,B$任一通道；

$R,G,B$：分别指的是$R,G,B$通道；

$G$: 灰度；

$s,sl$: 下标，测量数据及其线性化的值，前者是输入，后者是输出；

$d,dl$: 下标，参考数据及其线性化的值；



### 恒等变换

恒等变换线性化时不做任何改变，通常原因是输入的RGB图像通道值与亮度成正比。比如输入的测量数据为RAW格式，那么测量数据已经是线性化了的，因此不需要进行线性化。

恒等变换的公式如下：
$$
C_{sl}=C_s
$$

### 伽马校正

伽马校正是RGB空间进行非线性的手段，可以见色彩空间文档。在线性化部分中，$\gamma$值通常设为2.2，也可以自定义。

伽马校正线性化的公式如下：
$$
C_{sl}=C_s^{\gamma},\qquad C_s\ge0\\
C_{sl}=-(-C_s)^{\gamma},\qquad C_s<0\\\\
$$

### 多项式拟合

多项式拟合便是使用多项式来进行线性化，设使用的多项式是：
$$
f(x)=a_nx^n+a_{n-1}x^{n-1}+...+a_0
$$
则：
$$
C_{sl}=f(C_s)
$$
实际使用时，为了防止过拟合，一般$n\le3$。

多项式拟合有许多变种，关键是在如何生成$f(x)$。通常需要使用线性化的参考数据和对应的测量数据来求多项式的参数，但主要，并非所有通道都可以参与计算。通常，需要去除掉饱和的测量数据，参见算法介绍文档。

#### RGB三个多项式拟合

RGB三通道使用不同的多项式[1-3]，即目标是生成三个多项式$r(x),g(x),b(x)$，使用这些多项式进行线性化：
$$
R_{sl}=r(R_s)\\
G_{sl}=g(G_s)\\
B_{sl}=b(B_s)\\
$$
多项式的生成是通过最小化测量数据和线性化参考数据之间的残差平方和来实现的，以R通道为例：
$$
r=\arg min_{f}(\Sigma (R_{dl}-f(R_s))^2)
$$
等价于对所有参考颜色的方程求最小方差回归，即：
$$
f(R_{s1})=R_{dl1}\\
f(R_{s2})=R_{dl2}\\
...
$$
带入多项式，回归方程变成：
$$
\begin{bmatrix}
R_{s1}^{n} & R_{s1}^{n-1} & ... & 1\\ 
R_{s2}^{n} & R_{s2}^{n-1} & ... & 1\\ 
... & ... & ... & ...
\end{bmatrix}
\begin{bmatrix}
a_{n}\\ 
a_{n-1}\\ 
... \\
a_0
\end{bmatrix}
=
\begin{bmatrix}
R_{dl1}\\ 
R_{dl2}\\ 
... 
\end{bmatrix}
$$
最终可以表示为线性方程组：
$$
AX=B
$$
当参考颜色数≥n时，线性系统有最小二乘解：
$$
X=(A^TA)^{-1}A^TB
$$
获得多项式系数后，我们便可以获得多项式r。

这个求多项式系数的方法在numpy中可以使用numpy.polyfit去实现，在这里表示为：
$$
r=polyfit(R_s,R_{dl})
$$
要注意的是，通常情况下，我们希望得到的多项式能保证在[0,1]区间单调递增，但这意味着需要使用非线性的方法去生成多项式。可以参考使用[4]的方法。这样无疑是极大的增加了程序的复杂程度，而且单调性与否并不影响程序的色彩校正程序的正确运行，因此，最终仍使用polyfit去实现程序。

其他通道的参数也可以通过类似方法求出。

#### 灰度多项式拟合

该方法[2]所有通道都用一个多项式，这个多项式是仍然是从最小化测量数据到线性化参考数据的最优结果，但数据仅取参考数据中的黑白灰色的数据，舍弃掉有色彩的数据。

由于参考数据中灰度对应的测量数据未必是灰色的，因此需要将其灰度化。由于灰度通常是指的是XYZ色彩空间的Y通道，由于测量数据的色彩空间未定，不能转换成XYZ空间，因此采用了sRGB的近似公式来近似[5]：
$$
G_{s}=0.2126R_{s}+0.7152G_{s}+0.0722B_{s}
$$
此时多项式参数可通过polyfit获得：
$$
f=polyfit(G_{s},G_{dl})
$$
获得$f$后，便可进行线性化。

#### 对数多项式拟合

对伽马校正我们取对数，有：
$$
ln(C_{sl})={\gamma}ln(C_s),\qquad C_s\ge0\\
$$
可见$ln(C_s)$和$ln(C_{sl})$之间存在线性关系，可以认为上述公式是多项式关系的近似，即认为存在多项式$f$, 使得[2]：
$$
ln(C_{sl})=f(ln(C_s)), \qquad C_s>0\\
C_{sl}=0, \qquad C_s=0
$$
由于$exp(ln(0))\to0$, 因此上式对于分量为0的通道直接对应成0。

对于RGB三个多项式拟合，可以有：
$$
r=polyfit(ln(R_s),ln(R_{dl}))\\
g=polyfit(ln(G_s),ln(G_{dl}))\\
b=polyfit(ln(B_s),ln(B_{dl}))\\
$$
注意$ln$的参数不能为0，所以需要将$R_s$和$R_{dl}$中为0的通道去除。

因此：
$$
ln(R_{sl})=r(ln(R_s)), \qquad R_s>0\\
R_{sl}=0, \qquad R_s=0\\
ln(G_{sl})=g(ln(G_s)),\qquad G_s>0\\
G_{sl}=0, \qquad G_s=0\\
ln(B_{sl})=b(ln(B_s)),\qquad B_s>0\\
B_{sl}=0, \qquad B_s=0\\
$$
对于灰度多项式，同样获得：
$$
f=polyfit(ln(G_{sl}),ln(G_{dl}))
$$
线性化：
$$
ln(C_{sl})=f(ln(C_s)), \qquad C_s>0\\
C_{sl}=0, \qquad C_s=0
$$

## 参考文献

1. http://www.its.bldrdoc.gov/pub/ntia-rpt/04-406/
2. https://www.imatest.com/docs/colormatrix/
3. http://im.snibgo.com/col2mp.htm
4. https://math.stackexchange.com/questions/60610/polynomial-fitting-where-polynomial-must-be-monotonically-increasing
5. https://en.wikipedia.org/wiki/Grayscale




